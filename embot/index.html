<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<h1></h1>
<span>use arrow keys to control the robot</span>
<script src="/socket.io/socket.io.js"></script>
<script>
    var msgs = ['EmBot is in auto mode', 'You are controlling EmBot now!'];
    document.addEventListener("DOMContentLoaded", function (event) {
        var manual = false;
        var socket = io.connect();
        socket.on('connect', function () {
            console.log('connected');
        });

        var $h1 = document.querySelector('h1');
        $h1.innerText = msgs[0];


        var map = {
            37: 'left',
            38: 'up',
            39: 'right',
            40: 'down'
        };
        var keysPressed = {
            left: false,
            up: false,
            right: false,
            down: false
        };



        document.addEventListener('keydown', function (e) {
            if(map[e.which]){
                if(!manual){
                    changeCtrl(true);
                }
                keysPressed[map[e.which]] = true;
                sendData();
            }
        });
        document.addEventListener('keyup', function (e) {
            if(map[e.which]){
                keysPressed[map[e.which]] = false;
                sendData();
            }
        });

        var timeout;
        function sendData(){
            if (manual) {
                clearTimeout(timeout);
                console.log(keysPressed);
                socket.emit('ctrl', keysPressed);
                timeout = setTimeout(function(){
                    var somethingPressed = false;
                    for(var i in keysPressed){
                        if(keysPressed[i]){
                            somethingPressed = true;
                            break;
                        }
                    }
                    if(!somethingPressed){
                        changeCtrl(false);
                    }
                }, 2000);
            }
        }

        function changeCtrl(_manual){
            manual = _manual;
            socket.emit('ctrl-change', manual);
            if (manual) {
                $h1.innerText = msgs[1];
            } else {
                $h1.innerText = msgs[0];
            }
        }
    });
</script>
</body>
</html>